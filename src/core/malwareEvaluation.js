import { sanitizeIPString, isIPv6 } from '../utils/intel/ip.js';
import { ban } from './ban.js';
import { prolongExistingBan } from '../data/sql/Ban.js';
import { getState } from './SharedState.js';
import { checkIfSameProvider } from '../utils/intel/index.js';

/*
 * last time we made a whois for a tuxlerIp triggered by an ip, track this to
 * avoid abusive spam
 */
const lastReports = new Map();

/**
 * evaluate malware check on the server
 * @param user
 * @param ip ip middleware object
 * @param tuxlerResp ip response of tuxler from client
 */
export default async function evaluateMalwareCheck(
  user, ip, tuxlerResp, pupeteerPortAvailable, tuxlerWsAvailable,
) {
  if (!getState().malwareCheck) {
    return;
  }
  const { ipString } = ip;

  let reason;
  let duration;
  let tuxlerIp = null;

  /* eslint-disable max-len */
  const isV6 = isIPv6(ipString);
  if (tuxlerResp) {
    tuxlerIp = sanitizeIPString(tuxlerResp);
    if (isIPv6(tuxlerIp) === isV6
      && ((
        isV6 && tuxlerIp.split(':').length === 5 && ipString.substring(0, 8) !== tuxlerResp.substring(0, 8)
      ) || (
        !isV6 && tuxlerIp.split('.').length === 4 && ipString.substring(0, 6) !== tuxlerResp.substring(0, 6)
      ))
    ) {
      /* eslint-enable max-len */

      const lastReport = lastReports.get(ipString);
      const now = Date.now();
      if (!lastReport || lastReport + 1000 * 60 * 60 < now) {
        lastReports.set(ipString, now);
        if (lastReports.size > 100) {
          lastReports.clear();
        }

        const isSameProvider = await checkIfSameProvider(ipString, tuxlerIp);
        if (!isSameProvider) {
          reason = 'Proxy Malware detected';
          duration = 60 * 65 * 12;
        } else {
          console.log(
            // eslint-disable-next-line max-len
            `AUTOBAN ignore Proxy Malware for matching of  ${ipString}, ${tuxlerIp}`,
          );
        }
      }
    }
  }

  if (pupeteerPortAvailable) {
    reason = 'Malware Service detected';
    duration = 60 * 60 * 12;
  }

  if (tuxlerWsAvailable) {
    reason = 'Proxy Malware detected';
    duration = 60 * 65 * 12;
  }

  if (reason) {
    const { isWhitelisted } = await ip.getAllowance();
    if (isWhitelisted) {
      return;
    }

    const uid = user?.id;
    console.log(`AUTOBAN ${reason} ${ipString}, ${tuxlerIp}, ${uid}`);

    const didProlong = await prolongExistingBan(
      ipString, uid, duration, reason,
    );
    if (!didProlong) {
      await ban(ipString, uid, null, false, true, reason, duration);
    }
  }
}
