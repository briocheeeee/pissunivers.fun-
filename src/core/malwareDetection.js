import { fetchWithTimeout } from '../store/actions/fetch.js';

/**
 * check for malware client side, send information to server via websocket
 * @param socketClient
 */
export default async function checkForMalware(socketClient) {
  try {
    /*
    let tuxlerResp = await fetch(
      `${window.location.protocol}//api.tuxlervpn.com/STATUS_data.php`, {
        method: 'GET',
        referrerPolicy: 'no-referrer',
      },
    );
    if (!tuxlerResp.ok) {
      return;
    }
    tuxlerResp = await tuxlerResp.text();
    let start = tuxlerResp.indexOf('Your IP: ');
    if (start === -1) {
      return;
    }
    start += 9;
    const end = tuxlerResp.indexOf(' ', start);
    if (end === -1 || end > start + 39 || end < start + 8) {
      return;
    }
    // ip according to tuxler,
    // this will be the actual client ip, not the tuxler proxy ip
    tuxlerResp = tuxlerResp.substring(start, end);
    */

    /*
     * extended tuxler check cucrrently disabled because users behave well and
     * the false positives are currently not worth it
     */
    const tuxlerResp = null;

    /*
     * Test pupeteer APIs. Sadly they don't allow CORS, so we have to cope
     * and only check whether or not the port is open.
     */
    let pupeteerPortAvailable = false;
    try {
      await fetchWithTimeout('http://localhost:3001', {
        timeout: 600,
        mode: 'no-cors',
        cache: 'no-store',
      });
      pupeteerPortAvailable = true;
    } catch (error) {
      // nothing
    }

    /*
     * check for tuxler proxy helper application websocket
     */
    let tuxlerWsAvailable = false;
    await new Promise((resolve) => {
      let oneClosed = false;
      const onClose = () => {
        if (oneClosed) {
          resolve();
          return;
        }
        oneClosed = true;
      };
      const tryA = new WebSocket('ws://127.0.0.1:1701/tuxler');
      tryA.onopen = () => {
        tuxlerWsAvailable = true;
        tryA.close();
      };
      tryA.onclose = onClose;
      const tryB = new WebSocket('ws://127.0.0.1:1700/tuxler');
      tryB.onopen = () => {
        tuxlerWsAvailable = true;
        tryB.close();
      };
      tryB.onclose = onClose;
    });

    socketClient.sendWhenReady(`mr,${JSON.stringify([
      tuxlerResp, pupeteerPortAvailable, tuxlerWsAvailable,
    ])}`);
  } catch (error) {
    /* silently fail */
  }
}
